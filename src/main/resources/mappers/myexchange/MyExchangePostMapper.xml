<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
마이페이지 > 내 거래글 페이지
(거래글 목록, 거래상태 변경, 거래상대 조회 및 확정
-->
<mapper namespace="com.goodsple.features.myexchange.mapper.MyExchangePostMapper">

    <!-- 내 거래글 목록 조회 -->
    <select id="selectMyExchangePosts" resultType="com.goodsple.features.myexchange.dto.MyExchangePostDto">
        SELECT
        p.exchange_post_id AS exchangePostId,
        p.exchange_post_title AS exchangePostTitle,
        p.post_trade_status AS postTradeStatus,
        p.post_trade_type AS postTradeType,
        TO_CHAR(p.exchange_post_updated_at, 'YYYY.MM.DD HH24:MI') AS updatedAt,
        p.post_location_name AS postLocationName,
        p.delivery_price_normal AS deliveryPriceNormal,
        p.delivery_price_half AS deliveryPriceHalf,

        <!-- 내 거래글 페이지_대표 사진 불러오기-->
        (
        SELECT img.post_image_url
        FROM exchange_post_image img
        WHERE img.exchange_post_id = p.exchange_post_id
        ORDER BY img.post_sort_order ASC, img.post_image_created_at ASC
        LIMIT 1
        ) AS imageUrl

        FROM exchange_post p
        WHERE p.user_id = #{userId}

        <!-- 거래상태 필터(전체 선택 시 조건 미적용) -->
        <if test="status != null">
            AND p.post_trade_status = #{status}
        </if>

        ORDER BY p.exchange_post_updated_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 내 거래글 개수 조회(페이지네이션 용도) -->
    <select id="countMyExchangePosts" resultType="int">
        SELECT COUNT(*)
        FROM exchange_post p
        WHERE p.user_id = #{userId}
        <if test="status != null and status != ''">
            AND p.post_trade_status = #{status}
        </if>
    </select>

    <!-- 거래상태 변경 (판매자 본인만) -->
    <update id="updatePostStatus">
        UPDATE exchange_post
        SET post_trade_status        = #{status},
            exchange_post_updated_at = NOW()
        WHERE exchange_post_id = #{postId}
          AND user_id = #{userId}
    </update>

    <!--
    거래상대(채팅 사용자) 목록 조회
    특정 거래글 기준 (예.1번 글에 채팅건 사용자만 보임)
    판매자 본인(currentUserId) 제외
    마지막 채팅 시간 기준 내림차순 정렬
    최근 대화 기준으로 거래상대 후보 제공
     -->
    <select id="selectChatUsersByPostId"
            resultType="com.goodsple.features.myexchange.dto.ChatUserResponseDto">

        SELECT
        u.user_id AS userId,
        u.nickname AS nickname,
        u.profile_image AS profileImageUrl,
        <!-- 추후 배지 기능 연동 시 사용 -->
        <!-- b.badge_image_url   AS badgeIcon, -->

        <!-- 마지막 채팅으로부터 경과 일수 -->
        DATE_PART(
        'day',
        now() - MAX(c.chat_message_created_at)
        )::int AS lastChatDaysAgo
        FROM chat_room r
        JOIN chat_message c ON r.chat_room_id = c.chat_room_id
        <!--              JOIN badge b -->
        JOIN users u
        ON (u.user_id = r.user1_id OR u.user_id = r.user2_id)
        WHERE r.exchange_post_id = #{postId}
        AND u.user_id != #{currentUserId}
        GROUP BY u.user_id, u.nickname, u.profile_image
        ORDER BY MAX(c.chat_message_created_at) DESC
    </select>

    <!-- 거래글 판매자 여부 확인 (거래상대 지정 권한 검증) -->
    <select id="isPostOwner" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM exchange_post
        WHERE exchange_post_id = #{postId}
          AND user_id = #{userId}
    </select>


    <!-- 거래상대(구매자) 확정 , 판매자 본인만 가능 -->
    <update id="updateBuyer">
        UPDATE exchange_post
        SET buyer_id                 = #{buyerId},
            exchange_post_updated_at = NOW()
        WHERE exchange_post_id = #{postId}
          AND user_id = #{sellerId}
    </update>


    <!-- 마이페이지 > 거래내역 조회 -->
    <!-- 판매자 / 구매자 모두 포함 -->
    <!-- 후기 상태, 거래상대 지정 여부 계산 -->
    <select id="selectMyCompletedExchangeHistory"
            resultType="com.goodsple.features.myexchange.dto.MyCompletedExchangeDto">

        SELECT p.exchange_post_id                                AS exchangePostId,
               p.exchange_post_title                             AS title,
               p.post_trade_type                                 AS tradeMethod,
               TO_CHAR(p.exchange_post_updated_at, 'YYYY.MM.DD') AS tradedAt,

               p.user_id                                         AS sellerId, -- 판매자 ID
               p.buyer_id                                        AS buyerId,  -- 구매자 ID (미지정 가능)

               -- 현재 로그인 사용자 역할
               CASE
                   WHEN p.user_id = #{userId} THEN true
                   ELSE false
                   END                                           AS isSeller, -- 내가 판매자인지 여부

               CASE
                   WHEN p.buyer_id = #{userId} THEN true
                   ELSE false
                   END                                           AS isBuyer,  -- 내가 구매자인지 여부

               -- 거래 상대 닉네임
               CASE
                   -- 내가 판매자인 경우 → 구매자 닉네임
                   WHEN p.user_id = #{userId} THEN buyer.nickname
                   -- 내가 구매자인 경우 → 판매자 닉네임
                   ELSE seller.nickname
                   END                                           AS opponentNickname,

               -- 거래 상대 지정 버튼
               CASE
                   -- 판매자이고 아직 구매자를 지정하지 않은 경우
                   WHEN p.user_id = #{userId}
                       AND p.buyer_id IS NULL
                       THEN true
                   ELSE false
                   END                                           AS canSelectBuyer,

               -- 리뷰 존재 여부
               CASE
                   -- 구매자인 경우: 내가 작성한 리뷰가 있으면 true
                   WHEN p.buyer_id = #{userId} AND r.review_id IS NOT NULL THEN true
                   -- 판매자인 경우: 구매자가 작성한 리뷰가 있으면 true
                   WHEN p.user_id = #{userId} AND rb.review_id IS NOT NULL THEN true
                   ELSE false
                   END                                           AS reviewWritten,

               -- 리뷰 작성 가능 여부
               CASE
                   -- 구매자이고 아직 리뷰를 작성하지 않은 경우
                   WHEN p.buyer_id = #{userId}
                       AND r.review_id IS NULL
                       THEN true
                   ELSE false
                   END                                           AS canWriteReview,

               -- 대표이미지
               (SELECT img.post_image_url
                FROM exchange_post_image img
                WHERE img.exchange_post_id = p.exchange_post_id
                ORDER BY img.post_sort_order ASC
                LIMIT 1)                                         AS imageUrl

        FROM exchange_post p
                 /* 판매자 정보 */
                 JOIN users seller ON seller.user_id = p.user_id
            /* 구매자 정보 (구매자 미지정 가능) */
                 LEFT JOIN users buyer ON buyer.user_id = p.buyer_id

            /* 리뷰 정보
        - 내가 작성한 리뷰만 조인
        - 판매자 / 구매자 구분 없이 내 리뷰 존재 여부 확인용 */
                 LEFT JOIN reviews r
                           ON r.exchange_post_id = p.exchange_post_id
                               AND r.writer_id = #{userId}
                 LEFT JOIN reviews rb
                           ON rb.exchange_post_id = p.exchange_post_id
                               AND rb.writer_id = p.buyer_id

        /* 조회 조건 */
        WHERE p.post_trade_status = 'COMPLETED' -- 거래완료 상태만 조회
          AND (p.user_id = #{userId}            -- 내가 판매자인 경우
            OR p.buyer_id = #{userId})          -- 내가 구매자인 경우

        ORDER BY p.exchange_post_updated_at DESC
    </select>



    <!-- ===================================================  -->
    <select id="findFirstChatTime" resultType="java.time.LocalDateTime">
        SELECT MIN(chat_message_created_at)
        FROM chat_message
        WHERE exchange_post_id = #{postId}
          AND sender_id = #{userId}
    </select>

    <select id="findCompletedTime" resultType="java.time.LocalDateTime">
        SELECT exchange_post_updated_at
        FROM exchange_post
        WHERE exchange_post_id = #{postId}
    </select>


</mapper>
