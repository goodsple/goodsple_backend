<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.goodsple.features.postlist.mapper.PostListMapper">

    <select id="findAllPosts" resultType="com.goodsple.features.postlist.dto.PostListDto">
        SELECT p.exchange_post_id         AS exchangePostId,
               p.user_id                  AS writer,
               u.nickname                 AS writerNickname,
               p.exchange_post_created_at AS exchangePostCreatedAt,
               p.post_trade_status        AS postTradeStatus,
               p.exchange_post_title      AS exchangePostTitle
        FROM exchange_post p
                 JOIN users u ON p.user_id = u.user_id
        ORDER BY p.exchange_post_created_at DESC
    </select>

    <select id="findPostsByCategory" parameterType="long" resultType="com.goodsple.features.postlist.dto.PostListDto">
        SELECT p.exchange_post_id         AS exchangePostId,
               p.user_id                  AS writer,
               u.nickname                 AS writerNickname,
               p.exchange_post_created_at AS exchangePostCreatedAt,
               p.post_trade_status        AS postTradeStatus,
               p.exchange_post_title      AS exchangePostTitle
        FROM exchange_post p
                 JOIN users u ON p.user_id = u.user_id
                 JOIN third_cate t ON p.third_cate_id = t.third_cate_id
                 JOIN second_cate s ON t.second_cate_id = s.second_cate_id
                 JOIN first_cate f ON s.first_cate_id = f.first_cate_id
        WHERE f.first_cate_id = #{categoryId}
        ORDER BY p.exchange_post_created_at DESC
    </select>

    <!-- ê°™ì€ ì´ë¦„ì˜ ëª¨ë“  3ì°¨ ID ì¡°íšŒ -->
    <select id="findThirdIdsBySameName" resultType="long">
        SELECT t2.third_cate_id
        FROM third_cate t1
        JOIN third_cate t2 ON t1.cate_name = t2.cate_name
        WHERE t1.third_cate_id IN
        <foreach collection="thirdIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- ðŸ”¹ 3ì°¨ ì„ íƒ ì‹œ ì—°ê²°ëœ ëª¨ë“  2ì°¨ ID ì¡°íšŒ -->
    <select id="findSecondIdsByThirdNames" parameterType="map" resultType="long">
        SELECT DISTINCT t2.second_cate_id
        FROM third_cate t1
        JOIN third_cate t2 ON t1.cate_name = t2.cate_name
        WHERE t1.third_cate_id IN
        <foreach collection="thirdIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>



    <!-- ðŸ”¹ 2ì°¨/3ì°¨ ì¹´í…Œê³ ë¦¬ ê¸°ì¤€ ê¸€ ì¡°íšŒ -->
    <select id="findPostsBySecondAndThird" parameterType="com.goodsple.features.postlist.dto.PostFilterDto"
            resultType="com.goodsple.features.postlist.dto.PostListDto">
        SELECT DISTINCT
        p.exchange_post_id         AS exchangePostId,
        p.user_id                  AS writer,
        u.nickname                 AS writerNickname,
        p.exchange_post_created_at AS exchangePostCreatedAt,
        p.post_trade_status        AS postTradeStatus,
        p.exchange_post_title      AS exchangePostTitle
        FROM exchange_post p
        JOIN users u ON p.user_id = u.user_id
        JOIN third_cate t ON p.third_cate_id = t.third_cate_id
        <!-- LEFT JOIN second_cate s ON t.second_cate_id = s.second_cate_id -->
         <where>
             <!-- 3ì°¨ê°€ ìžˆìœ¼ë©´ ë¬´ì¡°ê±´ 3ì°¨ ê¸°ì¤€ -->
            <if test="thirdIds != null and !thirdIds.isEmpty()">
                p.third_cate_id IN
                <foreach collection="thirdIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>

            <!-- 3ì°¨ê°€ ì—†ì„ë•Œë§Œ 2ì°¨ ì‚¬ìš© -->
<!--            <if test="(thirdIds == null or thirdIds.isEmpty())-->
<!--        and (secondIds != null and !secondIds.isEmpty())">-->
<!--                s.second_cate_id IN-->
<!--                <foreach collection="secondIds" item="id" open="(" separator="," close=")">-->
<!--                    #{id}-->
<!--                </foreach>-->
<!--            </if>-->
        </where>
        ORDER BY p.exchange_post_created_at DESC
    </select>


    <select id="findThirdIdsBySecondIds" resultType="long">
        SELECT third_cate_id
        FROM third_cate
        WHERE second_cate_id IN
        <foreach collection="secondIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

</mapper>