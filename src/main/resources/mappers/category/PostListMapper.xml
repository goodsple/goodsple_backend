<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.goodsple.features.postlist.mapper.PostListMapper">

    <select id="findAllPosts" resultType="com.goodsple.features.postlist.dto.PostListDto">
        SELECT p.exchange_post_id         AS exchangePostId,
               p.user_id                  AS writer,
               u.nickname                 AS writerNickname,
               p.exchange_post_created_at AS exchangePostCreatedAt,
               p.post_trade_status        AS postTradeStatus,
               p.exchange_post_title      AS exchangePostTitle
        FROM exchange_post p
                 JOIN users u ON p.user_id = u.user_id
        ORDER BY p.exchange_post_created_at DESC
    </select>

    <select id="findPostsByCategory" parameterType="long" resultType="com.goodsple.features.postlist.dto.PostListDto">
        SELECT p.exchange_post_id         AS exchangePostId,
               p.user_id                  AS writer,
               u.nickname                 AS writerNickname,
               p.exchange_post_created_at AS exchangePostCreatedAt,
               p.post_trade_status        AS postTradeStatus,
               p.exchange_post_title      AS exchangePostTitle
        FROM exchange_post p
                 JOIN users u ON p.user_id = u.user_id
                 JOIN third_cate t ON p.third_cate_id = t.third_cate_id
                 JOIN second_cate s ON t.second_cate_id = s.second_cate_id
                 JOIN first_cate f ON s.first_cate_id = f.first_cate_id
        WHERE f.first_cate_id = #{categoryId}
        ORDER BY p.exchange_post_created_at DESC
    </select>

    <!-- ê°™ì€ ì´ë¦„ì˜ ëª¨ë“  3ì°¨ ID ì¡°íšŒ -->
    <select id="findThirdIdsBySameName" resultType="long">
        SELECT t2.third_cate_id
        FROM third_cate t1
        JOIN third_cate t2 ON t1.cate_name = t2.cate_name
        WHERE t1.third_cate_id IN
        <foreach collection="thirdIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- ðŸ”¹ 3ì°¨ ì„ íƒ ì‹œ ì—°ê²°ëœ ëª¨ë“  2ì°¨ ID ì¡°íšŒ -->
    <select id="findSecondIdsByThirdNames" parameterType="map" resultType="long">
        SELECT DISTINCT t2.second_cate_id
        FROM third_cate t1
        JOIN third_cate t2 ON t1.cate_name = t2.cate_name
        WHERE t1.third_cate_id IN
        <foreach collection="thirdIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>



    <!-- ðŸ”¹ 2ì°¨/3ì°¨ ì¹´í…Œê³ ë¦¬ ê¸°ì¤€ ê¸€ ì¡°íšŒ -->
    <select id="findPostsBySecondAndThird" parameterType="com.goodsple.features.postlist.dto.PostFilterDto"
            resultType="com.goodsple.features.postlist.dto.PostListDto">
        SELECT DISTINCT
        p.exchange_post_id         AS exchangePostId,
        p.user_id                  AS writer,
        u.nickname                 AS writerNickname,
        p.exchange_post_created_at AS exchangePostCreatedAt,
        p.post_trade_status        AS postTradeStatus,
        p.exchange_post_title      AS exchangePostTitle
        FROM exchange_post p
        JOIN users u ON p.user_id = u.user_id
        JOIN third_cate t ON p.third_cate_id = t.third_cate_id
        <!-- LEFT JOIN second_cate s ON t.second_cate_id = s.second_cate_id -->
         <where>
             <!-- 3ì°¨ê°€ ìžˆìœ¼ë©´ ë¬´ì¡°ê±´ 3ì°¨ ê¸°ì¤€ -->
            <if test="thirdIds != null and !thirdIds.isEmpty()">
                p.third_cate_id IN
                <foreach collection="thirdIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>

            <!-- 3ì°¨ê°€ ì—†ì„ë•Œë§Œ 2ì°¨ ì‚¬ìš© -->
<!--            <if test="(thirdIds == null or thirdIds.isEmpty())-->
<!--        and (secondIds != null and !secondIds.isEmpty())">-->
<!--                s.second_cate_id IN-->
<!--                <foreach collection="secondIds" item="id" open="(" separator="," close=")">-->
<!--                    #{id}-->
<!--                </foreach>-->
<!--            </if>-->
        </where>
        ORDER BY p.exchange_post_created_at DESC
    </select>


    <select id="findThirdIdsBySecondIds" resultType="long">
        SELECT third_cate_id
        FROM third_cate
        WHERE second_cate_id IN
        <foreach collection="secondIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

</mapper>

        <!-- ì „ì²´ ê¸€ ì¡°íšŒ -->
        <!--    <select id="findAllPosts" resultType="com.goodsple.features.postlist.dto.PostListDto">-->
        <!--        SELECT p.exchange_post_id         AS exchangePostId,-->
        <!--               p.user_id                  AS writer,-->
        <!--               u.nickname                 AS writerNickname,-->
        <!--               p.exchange_post_created_at AS exchangePostCreatedAt,-->
        <!--               p.post_trade_status        AS postTradeStatus,-->
        <!--               p.exchange_post_title      AS exchangePostTitle-->
        <!--        FROM exchange_post p-->
        <!--                 JOIN users u ON p.user_id = u.user_id-->
        <!--        ORDER BY exchange_post_created_at DESC-->
        <!--    </select>-->

        <!--    &lt;!&ndash; 1ì°¨ ì¹´í…Œê³ ë¦¬ë³„ ê¸€ ì¡°íšŒ &ndash;&gt;-->
        <!--    <select id="findPostsByCategory" parameterType="long" resultType="com.goodsple.features.postlist.dto.PostListDto">-->
        <!--        SELECT p.exchange_post_id         AS exchangePostId,-->
        <!--               p.user_id                  AS writer,-->
        <!--               u.nickname                 AS writerNickname,-->
        <!--               p.exchange_post_created_at AS exchangePostCreatedAt,-->
        <!--               p.post_trade_status        AS postTradeStatus,-->
        <!--               p.exchange_post_title      AS exchangePostTitle-->
        <!--        FROM exchange_post p-->
        <!--                 JOIN users u ON p.user_id = u.user_id-->
        <!--                 JOIN third_cate t ON p.third_cate_id = t.third_cate_id-->
        <!--                 JOIN second_cate s ON t.second_cate_id = s.second_cate_id-->
        <!--                 JOIN first_cate f ON s.first_cate_id = f.first_cate_id-->
        <!--        WHERE f.first_cate_id = #{categoryId}-->
        <!--        ORDER BY p.exchange_post_created_at DESC-->
        <!--    </select>-->

        <!--    &lt;!&ndash; 3ì°¨ë§Œ ì„ íƒ ì‹œ, í•´ë‹¹ 3ì°¨ì— ì—°ê²°ëœ 2ì°¨ ID ì¡°íšŒ &ndash;&gt;-->
        <!--    <select id="findSecondIdsByThirdIds" resultType="long">-->
        <!--        SELECT DISTINCT second_cate_id-->
        <!--        FROM third_cate-->
        <!--        WHERE third_cate_id IN-->
        <!--        <foreach collection="thirdIds" item="id" open="(" separator="," close=")">-->
        <!--            #{id}-->
        <!--        </foreach>-->
        <!--    </select>-->

        <!--    &lt;!&ndash; 2ì°¨/3ì°¨ ì¹´í…Œê³ ë¦¬ í•„í„°ë§ &ndash;&gt;-->
        <!--    <select id="findPostsBySecondAndThird" resultType="com.goodsple.features.postlist.dto.PostListDto">-->
        <!--        SELECT p.exchange_post_id AS exchangePostId,-->
        <!--        p.user_id AS writer,-->
        <!--        u.nickname AS writerNickname,-->
        <!--        p.exchange_post_created_at AS exchangePostCreatedAt,-->
        <!--        p.post_trade_status AS postTradeStatus,-->
        <!--        p.exchange_post_title AS exchangePostTitle-->
        <!--        FROM exchange_post p-->
        <!--        LEFT JOIN users u ON p.user_id = u.user_id-->
        <!--        LEFT JOIN third_cate t ON p.third_cate_id = t.third_cate_id-->
        <!--        LEFT JOIN second_cate s ON t.second_cate_id = s.second_cate_id-->
        <!--        <where>-->
        <!--            <if test="secondIds != null and !secondIds.isEmpty()">-->
        <!--                s.second_cate_id IN-->
        <!--                <foreach collection="secondIds" item="id" open="(" separator="," close=")">-->
        <!--                    #{id}-->
        <!--                </foreach>-->
        <!--            </if>-->
        <!--            <if test="thirdIds != null and !thirdIds.isEmpty()">-->
        <!--                AND p.third_cate_id IN-->
        <!--                <foreach collection="thirdIds" item="id" open="(" separator="," close=")">-->
        <!--                    #{id}-->
        <!--                </foreach>-->
        <!--            </if>-->
        <!--        </where>-->
        <!--        ORDER BY p.exchange_post_created_at DESC-->
        <!--    </select>-->

        <!--    &lt;!&ndash; ðŸ”§ ì „ì²´ 2ì°¨ ì„ íƒ ì‹œ ì—°ê²°ëœ ëª¨ë“  3ì°¨ ê°€ì ¸ì˜¤ê¸° &ndash;&gt;-->
        <!--    <select id="findThirdIdsBySecondIds" resultType="java.lang.Long">-->
        <!--        SELECT third_cate_id-->
        <!--        FROM third_cate-->
        <!--        WHERE second_cate_id IN-->
        <!--        <foreach collection="list" item="id" open="(" separator="," close=")">-->
        <!--            #{id}-->
        <!--        </foreach>-->
        <!--    </select>-->

        <!--    &lt;!&ndash; 3ì°¨ ì„ íƒ ì‹œ, ì´ë¦„ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  2ì°¨ ID ì¡°íšŒ &ndash;&gt;-->
        <!--    <select id="findSecondIdsByThirdNames" parameterType="map" resultType="long">-->
        <!--        SELECT DISTINCT t2.second_cate_id-->
        <!--        FROM third_cate t1-->
        <!--        JOIN third_cate t2 ON t1.cate_name = t2.cate_name-->
        <!--        WHERE t1.third_cate_id IN-->
        <!--        <foreach collection="thirdIds" item="id" open="(" separator="," close=")">-->
        <!--            #{id}-->
        <!--        </foreach>-->
        <!--    </select>-->


        <!-- ê·¸.. ê°€ìž¥ ë©€ì©¡í•œ ë²„ì „?-->
        <!--    <select id="findPostsBySecondAndThird" resultType="com.goodsple.features.postlist.dto.PostListDto">-->
        <!--        SELECT p.exchange_post_id         AS exchangePostId,-->
        <!--        p.user_id                  AS writer,-->
        <!--        u.nickname                 AS writerNickname,-->
        <!--        p.exchange_post_created_at AS exchangePostCreatedAt,-->
        <!--        p.post_trade_status        AS postTradeStatus,-->
        <!--        p.exchange_post_title      AS exchangePostTitle-->
        <!--        FROM exchange_post p-->
        <!--        LEFT JOIN users u ON p.user_id = u.user_id-->
        <!--        LEFT JOIN third_cate t ON p.third_cate_id = t.third_cate_id-->
        <!--        LEFT JOIN second_cate s ON t.second_cate_id = s.second_cate_id-->
        <!--        <where>-->

        <!--            &lt;!&ndash; ðŸ”¥ thirdIdsê°€ ì¡´ìž¬í•˜ë©´ thirdë§Œ í•„í„°ë§ &ndash;&gt;-->
        <!--            <if test="thirdIds != null and !thirdIds.isEmpty()">-->
        <!--                p.third_cate_id IN-->
        <!--                <foreach collection="thirdIds" item="id" open="(" separator="," close=")">-->
        <!--                    #{id}-->
        <!--                </foreach>-->
        <!--            </if>-->

        <!--            &lt;!&ndash; ðŸ”¥ thirdIdsê°€ ì—†ê³  secondë§Œ ìžˆì„ ë•Œ second í•„í„°ë§ &ndash;&gt;-->
        <!--            <if test="(thirdIds == null or thirdIds.isEmpty())-->
        <!--                  and (secondIds != null and !secondIds.isEmpty())">-->
        <!--                AND s.second_cate_id IN-->
        <!--                <foreach collection="secondIds" item="id" open="(" separator="," close=")">-->
        <!--                    #{id}-->
        <!--                </foreach>-->
        <!--            </if>-->
        <!--        </where>-->
        <!--        ORDER BY p.exchange_post_created_at DESC-->
        <!--    </select>-->


        <!--    <select id="findPostsBySecondAndThird" parameterType="map"  resultType="com.goodsple.features.postlist.dto.PostListDto">-->
        <!--        SELECT-->
        <!--        p.exchange_post_id,-->
        <!--        p.user_id AS writer,-->
        <!--        u.nickname AS writerNickname,-->
        <!--        p.exchange_post_created_at,-->
        <!--        p.post_trade_status,-->
        <!--        p.exchange_post_title-->
        <!--        FROM exchange_post p-->
        <!--        LEFT JOIN users u ON p.user_id = u.user_id-->
        <!--        LEFT JOIN third_cate t ON p.third_cate_id = t.third_cate_id-->
        <!--        LEFT JOIN second_cate s ON t.second_cate_id = s.second_cate_id-->
        <!--        WHERE 1=1-->
        <!--        &lt;!&ndash; 2ì°¨ ì¹´í…Œê³ ë¦¬ í•„í„° &ndash;&gt;-->
        <!--        <if test="secondIds != null and !secondIds.isEmpty()">-->
        <!--            AND s.second_cate_id IN-->
        <!--            <foreach item="item" collection="secondIds" open="(" separator="," close=")">-->
        <!--                #{item}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        &lt;!&ndash; 3ì°¨ ì¹´í…Œê³ ë¦¬ í•„í„° &ndash;&gt;-->
        <!--        <if test="thirdIds != null and !thirdIds.isEmpty()">-->
        <!--            AND t.third_cate_id IN-->
        <!--            <foreach item="item" collection="thirdIds" open="(" separator="," close=")">-->
        <!--                #{item}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        ORDER BY p.exchange_post_created_at DESC-->
        <!--    </select>-->


        <!-- 2ì°¨ ì¹´í…Œê³ ë¦¬ í•„í„°ë§ ê°€ëŠ¥ -->
        <!--    <select id="findPostsBySecondAndThird" parameterType="com.goodsple.features.postlist.dto.PostFilterDto"-->
        <!--            resultType="com.goodsple.features.postlist.dto.PostListDto">-->
        <!--        SELECT p.exchange_post_id,-->
        <!--        p.user_id AS writer,-->
        <!--        u.nickname AS writerNickname,-->
        <!--        p.exchange_post_created_at,-->
        <!--        p.post_trade_status,-->
        <!--        p.exchange_post_title-->
        <!--        FROM exchange_post p-->
        <!--        LEFT JOIN third_cate t ON p.third_cate_id = t.third_cate_id-->
        <!--        LEFT JOIN second_cate s ON t.second_cate_id = s.second_cate_id-->
        <!--        LEFT JOIN users u ON p.user_id = u.user_id-->
        <!--        WHERE 1=1-->
        <!--        <if test="filter.secondIds != null and !filter.secondIds.isEmpty()">-->
        <!--            AND s.second_cate_id IN-->
        <!--            <foreach collection="filter.secondIds" item="id" open="(" separator="," close=")">-->
        <!--                #{id}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        <if test="filter.thirdIds != null and !filter.thirdIds.isEmpty()">-->
        <!--            AND p.third_cate_id IN-->
        <!--            <foreach collection="filter.thirdIds" item="id" open="(" separator="," close=")">-->
        <!--                #{id}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        ORDER BY p.exchange_post_created_at DESC-->
        <!--    </select>-->

        <!--</mapper>-->
